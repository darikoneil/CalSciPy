from __future__ import annotations

import numpy as np

from scipy.ndimage.filters import median_filter

import matplotlib
matplotlib.use("Qt5Agg")
from matplotlib import pyplot as plt
import seaborn as sns
from matplotlib.backends.qt_compat import QtCore, QtWidgets, QtGui
from matplotlib.backends.backend_qt5agg import FigureCanvas
from matplotlib.gridspec import GridSpec


class PSF:
    def __init__(self, psf, headless=False):
        self.scaling = (0.5, 0.1, 0.1)
        self.planes, self.y_pixels, self.x_pixels = psf.shape
        self.image = psf
        self.denoised = None
        self.FWHM = None
        self.med_filt = 1
        self.z_fit_order = 1
        self.z_max = None

        self._denoise()

        # if not headless:
        #    interactive_psf(self)

    def _denoise(self):
        self.denoised = median_filter(self.image, footprint=np.ones((3, 3, 3)), mode="nearest")

    @property
    def center(self):
        return np.argmax(np.sum(self.denoised, axis=(1, 2)))


def interactive_psf(psf):
    fig = plt.figure()
    gs = GridSpec(2, 2)
    # current plane
    ax1 = plt.subplot(gs[0, 0])
    # center plane
    ax2 = plt.subplot(gs[0, 1])
    # XZ
    ax3 = plt.subplot(gs[1, 0])
    # YZ
    ax4 = plt.subplot(gs[1, 1])

    current_plane = 0

    # current plane
    ax1.imshow(psf.denoised[current_plane, :, :], cmap="mako")
    ax1.set_xticks([])
    ax1.set_yticks([])

    # center plane
    ax2.imshow(psf.denoised[psf.center, :, :], cmap="mako")
    ax2.set_xticks([])
    ax2.set_yticks([])

    def update():
        cp = plane_slider.value()
        ax1.clear()
        ax1.imshow(psf.denoised[cp, :, :], cmap="mako")
        fig.canvas.draw()

    plane_slider = QtWidgets.QSlider(QtCore.Qt.Vertical)
    plane_slider.setRange(0, 50)
    plane_slider.setSingleStep(1)
    plane_slider.setValue(0)
    plane_slider.sliderMoved.connect(update)
    vbox = QtWidgets.QVBoxLayout()
    vbox.addWidget(plane_slider)
    fig.canvas.setLayout(vbox)
    plt.show()

    return fig


psf = PSF(np.load("C:\\Users\\YUSTE\\Desktop\\PSF.npy"))

_ = interactive_psf(psf)
